name: BDD tests


on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  bdd:
    runs-on: ubuntu-latest
    name: BDD tests
    container: quay.io/redhat-services-prod/obsint-processing-tenant/insights-behavioral-spec/insights-behavioral-spec:latest
    env:
      PATH_TO_LOCAL_PARQUET_FACTORY: "${{ github.workspace }}"
      BDD_PATH: /insights-behavioral-spec
      VIRTUAL_ENV: /insights-behavioral-spec-venv/
    services:
      kafka:
        image: quay.io/ccxdev/kafka-no-zk:latest
      minio:
        image: quay.io/ccxdev/minio-server-ubi:latest
        env:
          MINIO_ACCESS_KEY: test_access_key
          MINIO_SECRET_KEY: test_secret_access_key
          PORT: 9000
      pushgateway:
        # Custom image with --web.enable-admin-api flag enabled
        # Built by .github/workflows/build-pushgateway.yml
        image: quay.io/ccxdev/prom-pushgateway-admin:latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Add Go bin to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      - name: Build parquet-factory
        run: make build
      - name: Run BDD tests
        run: cd $BDD_PATH && make parquet-factory-tests
      - name: Rename logs
        # Otherwise the upload-artifact action will complain
        if: failure()
        run: for filename in "$BDD_PATH"/logs/parquet-factory/*; do mv -n "$filename" "$(echo "$filename" | sed -e 's/["><]//g')"; done
      - uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: bdd-logs
          path: /insights-behavioral-spec/logs/parquet-factory
